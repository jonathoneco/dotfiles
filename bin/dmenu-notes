#!/usr/bin/env bash

# Ensure ~/.local/bin is in PATH for scripts called from Hyprland
export PATH="$HOME/.local/bin:$PATH"

root_folder=$GARDEN_LOG_DIR
subfolder=""

newnote () { \
  name="$(echo "" | dmenu -c -sb "#a3be8c" -nf "#d8dee9" -p "Enter a name: " <&-)" || exit 0
  : "${name:=$(date +%F_%T | tr ':' '-')}"
  
  # Pass base filename without index - new-garden-log will auto-assign index
  if [ "$subfolder" = "" ]; then
    note_path="1 Inbox/$name.md"
  else
    note_path="$subfolder$name.md"
  fi

  new-garden-log "$note_path"
  
  # Find the actual created file (with auto-assigned index) to open in nvim
  target_dir="$root_folder/$(dirname "$note_path")"
  created_file=$(ls "$target_dir" | grep -E "^[0-9]+[[:space:]]+$(basename "$name" .md)" | tail -1)
  if [ -n "$created_file" ]; then
    setsid -f "$TERMINAL" -e nvim -c "cd $root_folder" "$target_dir/$created_file" >/dev/null 2>&1
  fi
}

selected () { \
  current_folder="$root_folder/$subfolder"
  # List directories first, then files, each sorted alphabetically (exclude . and ..)
  entries=$(cd "$current_folder" && (ls -d */ 2>/dev/null | grep -v '^\.\./$' | sort; ls -1 *.md 2>/dev/null | sort) | tr -d '/')

  # Build menu with back option at bottom if in subfolder
  if [ -n "$subfolder" ]; then
    menu_items="New\n..\n$entries"
  else
    menu_items="New\n$entries"
  fi

  choice=$(echo -e "$menu_items" | dmenu -c -l 10 -i -p "Choose note or create new: ") || exit 0
  case $choice in
    New) newnote ;;
     "..")
       # Remove the last directory from subfolder path
       subfolder=$(echo "$subfolder" | sed 's|[^/]*/$||')
       selected ;;    *.md) setsid -f "$TERMINAL" -e nvim -c "cd $root_folder" "$root_folder/$subfolder$choice" >/dev/null 2>&1 ;;
    *) if [ -d "$current_folder/$choice" ]; then
         subfolder="$subfolder$choice/"
         selected
       else
         exit
       fi ;;
  esac
}

selected
