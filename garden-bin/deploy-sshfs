#!/bin/bash

# Deploy script for SSHFS-mounted garden-bed project

MOUNT_POINT="$HOME/mnt/garden-bed"
DOCKER_CONTEXT="garden-bed"
COMPOSE_FILE="docker-compose-garden-bed.yml"

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m'

# Parse command
COMMAND="${1:-up -d}"

echo -e "${BLUE}=== Garden-bed Deployment (SSHFS) ===${NC}"

# Ensure mounted
if ! mountpoint -q "$MOUNT_POINT"; then
    echo -e "${YELLOW}Mount point not active. Mounting...${NC}"
    ~/projects/homelab/scripts/mount-garden-bed.sh
    if [ $? -ne 0 ]; then
        echo -e "${RED}Failed to mount!${NC}"
        exit 1
    fi
fi

# Switch context and run
echo -e "\n${YELLOW}Running docker-compose $COMMAND...${NC}"
cd "$MOUNT_POINT"
docker context use $DOCKER_CONTEXT
docker-compose -f $COMPOSE_FILE $COMMAND
EXIT_CODE=$?
docker context use default

if [ $EXIT_CODE -eq 0 ]; then
    echo -e "\n${GREEN}✓ Success!${NC}"
else
    echo -e "\n${RED}✗ Failed!${NC}"
fi